rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =====================================
    // functions
    // -------------------------------------
    // client portal — empty (fresh start)

    // employee portal

    // Convenience helpers
    function authed() { return request.auth != null; }

    // Active employee: signed in, has employees/{uid} doc, not archived, not removed
    function isEmployee() {
      return authed()
        && exists(/databases/$(database)/documents/employees/$(request.auth.uid))
        // Treat missing isArchived as not archived; avoid property access when absent
        && !(("isArchived" in get(/databases/$(database)/documents/employees/$(request.auth.uid)).data)
             && get(/databases/$(database)/documents/employees/$(request.auth.uid)).data.isArchived == true)
        && !("deletedAt" in get(/databases/$(database)/documents/employees/$(request.auth.uid)).data);
    }

    // Helper: admin based on employees/{auth.uid}.isAdmin, with owner included
    function isAdmin() {
      return (
        (
          authed() && exists(/databases/$(database)/documents/meta/owner)
          && get(/databases/$(database)/documents/meta/owner).data.ownerUid == request.auth.uid
        ) || (
          isEmployee()
          && get(/databases/$(database)/documents/employees/$(request.auth.uid)).data.isAdmin == true
        )
      );
    }

    // Helpers to read employee and roles
    function empDoc() { return get(/databases/$(database)/documents/employees/$(request.auth.uid)).data; }
    function hasOwnPermissionId(permId) {
      return isEmployee()
        && ("permissionIds" in empDoc())
        && (permId in empDoc().permissionIds);
    }
    function roleIds() { return ("roleIds" in empDoc()) ? empDoc().roleIds : []; }
    function roleHasPermAt(permId, idx) {
      return roleIds().size() > idx && (permId in get(/databases/$(database)/documents/ep_employee_roles/$(roleIds()[idx])).data.permissionIds);
    }
    function hasRolePermissionId(permId) {
      return roleHasPermAt(permId, 0)
        || roleHasPermAt(permId, 1)
        || roleHasPermAt(permId, 2)
        || roleHasPermAt(permId, 3)
        || roleHasPermAt(permId, 4);
    }
    function hasPermissionId(permId) { return hasOwnPermissionId(permId) || hasRolePermissionId(permId); }

    // Tag Manager permissions (IDs from permissions schema)
    function canReadTags() { return isAdmin() || hasPermissionId('perm-tag_manager-read'); }
    function canEditTags() { return isAdmin() || hasPermissionId('perm-tag_manager-edit'); }
    function canDeleteTags() { return isAdmin() || hasPermissionId('perm-tag_manager-delete'); }

    // TESTED BOUNDARY — rules helpers ABOVE this line are covered by tests; helpers BELOW are not yet covered
    // --------------------------------------------------------------------------------

    // =====================================
    // gateway
    // -------------------------------------
    // client portal — empty (fresh start)

    // employee portal

    // Employee Roles — admin/owner manage RBAC roles (employee portal)
    match /ep_employee_roles/{id} {
      // Read/list/delete remain admin-only
      allow get, list, delete: if isAdmin();
      // Sanitize on create/update
      allow create: if isAdmin()
        && (request.resource.data.name is string)
        && request.resource.data.name.size() > 0
        && request.resource.data.name.size() <= 40
        && (!('description' in request.resource.data)
            || ((request.resource.data.description is string)
                && request.resource.data.description.size() <= 280));
      allow update: if isAdmin()
        && (
          !('name' in request.resource.data)
          || ((request.resource.data.name is string)
              && request.resource.data.name.size() > 0
              && request.resource.data.name.size() <= 40)
        )
        && (
          !('description' in request.resource.data)
          || ((request.resource.data.description is string)
              && request.resource.data.description.size() <= 280)
        );
    }

    // CRM — tags (employee portal) and customers (admin-only for now)
    match /ep_tags/{id} {
      // Enforce permissions and basic name constraints to prevent abuse
      allow get, list: if canReadTags();
      allow create: if canEditTags()
        && (request.resource.data.name is string)
        && request.resource.data.name.size() > 0
        && request.resource.data.name.size() <= 40
        && (!('description' in request.resource.data)
            || ((request.resource.data.description is string)
                && request.resource.data.description.size() <= 280))
        && (!('color' in request.resource.data)
            || ((request.resource.data.color is string)
                && request.resource.data.color.size() <= 20));
      allow update: if canEditTags()
        && (
          // if name provided, enforce limit; if omitted, allow
          !('name' in request.resource.data)
          || ((request.resource.data.name is string)
              && request.resource.data.name.size() > 0
              && request.resource.data.name.size() <= 40)
        )
        && (
          // if description provided, enforce limit
          !('description' in request.resource.data)
          || ((request.resource.data.description is string)
              && request.resource.data.description.size() <= 280)
        )
        && (
          // if color provided, enforce limit
          !('color' in request.resource.data)
          || ((request.resource.data.color is string)
              && request.resource.data.color.size() <= 20)
        );
      allow delete: if canDeleteTags();
    }

    // Admin Settings — Employee Portal path
    function validAdminSettings() {
      return (
        // WEBSITE_URL length <= 200 when present
        !("websiteUrl" in request.resource.data)
        || (
          (request.resource.data.websiteUrl is string)
          && request.resource.data.websiteUrl.size() <= 200
        )
      ) && (
        // WEBSITE_NAME length <= 60 when present
        !("websiteName" in request.resource.data)
        || (
          (request.resource.data.websiteName is string)
          && request.resource.data.websiteName.size() <= 60
        )
      );
    }

    match /ep_admin_settings/{document=**} {
      allow get, list: if isAdmin();
      allow create: if isAdmin() && validAdminSettings();
      allow update: if isAdmin() && validAdminSettings();
      allow delete: if isAdmin();
    }

    // Privacy Policies — admin/owner only with basic limits
    function validPrivacyPolicyDoc() {
      return (
        !("title" in request.resource.data)
        || (
          (request.resource.data.title is string)
          && request.resource.data.title.size() > 0
          && request.resource.data.title.size() <= 120
        )
      ) && (
        !("bodyHtml" in request.resource.data)
        || (
          (request.resource.data.bodyHtml is string)
          && request.resource.data.bodyHtml.size() <= 20000
        )
      );
    }

    match /ep_privacy_policies/{id} {
      allow get, list: if isAdmin();
      allow create: if isAdmin() && validPrivacyPolicyDoc();
      allow update: if isAdmin() && validPrivacyPolicyDoc();
      allow delete: if isAdmin();
    }

    // Cookie Policies — admin/owner only with basic limits
    function validCookiePolicyDoc() {
      return (
        !("title" in request.resource.data)
        || (
          (request.resource.data.title is string)
          && request.resource.data.title.size() > 0
          && request.resource.data.title.size() <= 120
        )
      ) && (
        !("bodyHtml" in request.resource.data)
        || (
          (request.resource.data.bodyHtml is string)
          && request.resource.data.bodyHtml.size() <= 20000
        )
      );
    }

    match /eq_cookie_policies/{id} {
      allow get, list: if isAdmin();
      allow create: if isAdmin() && validCookiePolicyDoc();
      allow update: if isAdmin() && validCookiePolicyDoc();
      allow delete: if isAdmin();
    }


    // TESTED BOUNDARY — gateway rules ABOVE this line are covered by tests; rules BELOW are not yet covered
    // --------------------------------------------------------------------------------

    // Owner claim — one‑time create only
    match /meta/owner {
      allow create: if authed()
        && !exists(/databases/$(database)/documents/meta/owner)
        && request.resource.data.ownerUid == request.auth.uid;
      // Allow public read so sign‑in can detect the no‑owner state
      allow get: if true;
      // Disallow changing ownerUid after claim
      allow update: if false;
      allow delete: if false;
    }

    // Employees — admin-only create/delete; owner may read/update own basic fields
    function ownerEmployeeUpdate() {
      let diff = request.resource.data.diff(resource.data);
      return diff.addedKeys().size() == 0 && diff.removedKeys().size() == 0 && diff.changedKeys().hasOnly(['name','dateOfBirth','email','displayName']);
    }
    match /employees/{uid} {
      allow get, list: if isAdmin() || (authed() && uid == request.auth.uid);
      allow create, delete: if isAdmin();
      allow update: if isAdmin() || (authed() && (uid == request.auth.uid || resource.data.userId == request.auth.uid) && ownerEmployeeUpdate());
    }

    // Admin Settings — admin/owner only (legacy path)
    // match /admin_settings/{document=**} {
    //   allow get, list, create, update, delete: if isAdmin();
    // }

    match /crm_customers/{id} {
      allow get, list, create, update, delete: if isAdmin();
    }

    // Website — Newsbar (single doc)
    match /website/newsbar {
      // Public read
      allow get, list: if true;
      // Writes: admin/owner only
      allow create, update, delete: if isAdmin();
    }

    // Website — Blogs
    match /blogs/{id} {
      // Public read: published and not archived/removed; private read for admin/owner
      allow get, list: if (
        (resource.data.published == true && !(resource.data.isArchived == true) && !(resource.data.deletedAt != null))
        || isAdmin()
      );
      // Writes: admin/owner only
      allow create, update, delete: if isAdmin();
    }

    // Email Subscriptions — Newsletters (employee portal)
    function validNewsletterDoc() {
      return (
        !("subject" in request.resource.data)
        || (
          (request.resource.data.subject is string)
          && request.resource.data.subject.size() > 0
          && request.resource.data.subject.size() <= 200
        )
      ) && (
        !("body" in request.resource.data)
        || (
          (request.resource.data.body is string)
          && request.resource.data.body.size() <= 50000
        )
      ) && (
        !("status" in request.resource.data)
        || (request.resource.data.status in ['Draft','Scheduled','Sent'])
      ) && (
        !("recipients" in request.resource.data)
        || (request.resource.data.recipients is number)
      ) && (
        !("scheduledAt" in request.resource.data)
        || (request.resource.data.scheduledAt is number || request.resource.data.scheduledAt == null)
      ) && (
        !("sentAt" in request.resource.data)
        || (request.resource.data.sentAt is number || request.resource.data.sentAt == null)
      );
    }

    match /newsletters/{id} {
      // Read/list requires admin or newsletter read permission
      allow get, list: if isAdmin() || hasPermissionId('perm-email_newsletter-read');
      // Create/update requires admin or newsletter edit permission and valid fields
      allow create: if (isAdmin() || hasPermissionId('perm-email_newsletter-edit'))
        && (request.resource.data.subject is string)
        && request.resource.data.subject.size() > 0
        && validNewsletterDoc();
      allow update: if (isAdmin() || hasPermissionId('perm-email_newsletter-edit')) && validNewsletterDoc();
      // Delete requires admin or newsletter delete permission
      allow delete: if isAdmin() || hasPermissionId('perm-email_newsletter-delete');
    }

    // Admin Settings — Email Variables (employee portal)
    function validEmailVarDoc() {
      return (
        !("key" in request.resource.data)
        || (
          (request.resource.data.key is string)
          && request.resource.data.key.size() > 0
          && request.resource.data.key.size() <= 60
        )
      ) && (
        !("value" in request.resource.data)
        || (
          (request.resource.data.value is string)
          && request.resource.data.value.size() <= 1000
        )
      ) && (
        !("description" in request.resource.data)
        || (
          (request.resource.data.description is string)
          && request.resource.data.description.size() <= 280
        )
      );
    }

    // New root path for company settings
    match /ep_company_settings/global/email_vars/{id} {
      allow get, list: if isAdmin();
      allow create: if isAdmin()
        && (request.resource.data.key is string)
        && request.resource.data.key.size() > 0
        && request.resource.data.key.size() <= 60
        && validEmailVarDoc();
      allow update: if isAdmin() && validEmailVarDoc();
      allow delete: if isAdmin();
    }

    // Legacy path kept for backward compatibility (can be removed after data migration)
    match /admin_settings/global/email_vars/{id} {
      allow get, list: if isAdmin();
      allow create: if isAdmin()
        && (request.resource.data.key is string)
        && request.resource.data.key.size() > 0
        && request.resource.data.key.size() <= 60
        && validEmailVarDoc();
      allow update: if isAdmin() && validEmailVarDoc();
      allow delete: if isAdmin();
    }

    // Company Settings — Email Templates (employee portal)
    function validEmailTemplateDoc() {
      return (
        !("name" in request.resource.data)
        || (
          (request.resource.data.name is string)
          && request.resource.data.name.size() > 0
          && request.resource.data.name.size() <= 120
        )
      ) && (
        !("subject" in request.resource.data)
        || (
          (request.resource.data.subject is string)
          && request.resource.data.subject.size() > 0
          && request.resource.data.subject.size() <= 240
        )
      ) && (
        !("body" in request.resource.data)
        || (
          (request.resource.data.body is string)
          && request.resource.data.body.size() <= 50000
        )
      );
    }

    match /ep_company_settings/global/email_templates/{id} {
      allow get, list: if isAdmin();
      allow create: if isAdmin()
        && (request.resource.data.name is string)
        && request.resource.data.name.size() > 0
        && request.resource.data.name.size() <= 120
        && (request.resource.data.subject is string)
        && request.resource.data.subject.size() > 0
        && request.resource.data.subject.size() <= 240
        && validEmailTemplateDoc();
      allow update: if isAdmin() && validEmailTemplateDoc();
      allow delete: if isAdmin();
    }

    // Company Settings — System Emails (password reset, verify email)
    function validSystemEmailDoc() {
      return (
        !("subject" in request.resource.data)
        || (
          (request.resource.data.subject is string)
          && request.resource.data.subject.size() > 0
          && request.resource.data.subject.size() <= 240
        )
      ) && (
        !("body" in request.resource.data)
        || (
          (request.resource.data.body is string)
          && request.resource.data.body.size() <= 50000
        )
      );
    }

    match /ep_company_settings/global/system_emails/{id} {
      allow get, list: if isAdmin();
      allow create: if isAdmin()
        && (request.resource.data.subject is string)
        && request.resource.data.subject.size() > 0
        && request.resource.data.subject.size() <= 240
        && validSystemEmailDoc();
      allow update: if isAdmin() && validSystemEmailDoc();
      allow delete: if isAdmin();
    }

    

    // Notifications — readable by active employees/admin; writable by admin only
    match /ep_notifications/{id} {
      allow get, list: if isEmployee() || isAdmin();
      allow create, update, delete: if isAdmin();
    }

    // Deny everything else by default
    match /{document=**} {
      allow read, write: if false;
    }

    // User Settings — Appearance: owner or admin, auth users only
    match /user_settings_appearance/{id} {
      allow get, list: if isAdmin() || (authed() && resource.data.userId == request.auth.uid);
      allow create: if isAdmin() || (authed() && request.resource.data.userId == request.auth.uid
        && (request.resource.data.theme in ['light','dark','auto']));
      allow update: if isAdmin() || (authed() && resource.data.userId == request.auth.uid
        && !("userId" in request.resource.data) // cannot change owner
        && (!('theme' in request.resource.data) || (request.resource.data.theme in ['light','dark','auto'])));
      allow delete: if isAdmin() || (authed() && resource.data.userId == request.auth.uid);
    }
  }
}
