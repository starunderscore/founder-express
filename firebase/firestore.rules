rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =====================================
    // functions
    // -------------------------------------
    // client portal — empty (fresh start)

    // employee portal

    // Convenience helpers
    function authed() { return request.auth != null; }

    // Active employee: signed in, has employees/{uid} doc, not archived, not removed
    function isEmployee() {
      return authed()
        && exists(/databases/$(database)/documents/employees/$(request.auth.uid))
        // Treat missing isArchived as not archived; avoid property access when absent
        && !(("isArchived" in get(/databases/$(database)/documents/employees/$(request.auth.uid)).data)
             && get(/databases/$(database)/documents/employees/$(request.auth.uid)).data.isArchived == true)
        && !("deletedAt" in get(/databases/$(database)/documents/employees/$(request.auth.uid)).data);
    }

    // Helper: admin based on employees/{auth.uid}.isAdmin, with owner included
    function isAdmin() {
      return (
        (
          authed() && exists(/databases/$(database)/documents/meta/owner)
          && get(/databases/$(database)/documents/meta/owner).data.ownerUid == request.auth.uid
        ) || (
          isEmployee()
          && get(/databases/$(database)/documents/employees/$(request.auth.uid)).data.isAdmin == true
        )
      );
    }

    // TESTED BOUNDARY — rules helpers ABOVE this line are covered by tests; helpers BELOW are not yet covered
    // --------------------------------------------------------------------------------

    // =====================================
    // gateway
    // -------------------------------------
    // client portal — empty (fresh start)

    // employee portal

    // Employee Roles — admin/owner manage RBAC roles
    match /employee_roles/{id} {
      allow get, list, create, update, delete: if isAdmin();
    }

    // TESTED BOUNDARY — gateway rules ABOVE this line are covered by tests; rules BELOW are not yet covered
    // --------------------------------------------------------------------------------

    // Owner claim — one‑time create only
    match /meta/owner {
      allow create: if authed()
        && !exists(/databases/$(database)/documents/meta/owner)
        && request.resource.data.ownerUid == request.auth.uid;
      // Allow public read so sign‑in can detect the no‑owner state
      allow get: if true;
      // Disallow changing ownerUid after claim
      allow update: if false;
      allow delete: if false;
    }

    // Employees — admin/owner only
    match /employees/{uid} {
      allow get, list, create, update, delete: if isAdmin();
    }

    // Admin Settings — admin/owner only
    match /admin_settings/{document=**} {
      allow get, list, create, update, delete: if isAdmin();
    }

    // CRM — tags and customers (admin-only for now)
    match /crm_tags/{id} {
      allow get, list, create, update, delete: if isAdmin();
    }
    match /crm_customers/{id} {
      allow get, list, create, update, delete: if isAdmin();
    }

    // Website — Newsbar (single doc)
    match /website/newsbar {
      // Public read
      allow get, list: if true;
      // Writes: admin/owner only
      allow create, update, delete: if isAdmin();
    }

    // Website — Blogs
    match /blogs/{id} {
      // Public read: published and not archived/removed; private read for admin/owner
      allow get, list: if (
        (resource.data.published == true && !(resource.data.isArchived == true) && !(resource.data.deletedAt != null))
        || isAdmin()
      );
      // Writes: admin/owner only
      allow create, update, delete: if isAdmin();
    }

    

    // Notifications — readable by active employees/admin; writable by admin only
    match /notifications/{id} {
      allow get, list: if isEmployee() || isAdmin();
      allow create, update, delete: if isAdmin();
    }

    // Deny everything else by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
